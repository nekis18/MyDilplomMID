
&НаСервере
Процедура ФормированиеРТНаМесяца()
	
	//---//алгоритм должен выполняться с использованием механизма длительных операций БСП,
	
	//---//если Реализация за выбранный месяц уже создана, то обработка не должна создавать вторую,
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДоговорыКонтрагентов.Ссылка КАК Ссылка,
	|	ДоговорыКонтрагентов.Владелец КАК Владелец,
	|	ЕСТЬNULL(ДоговорыКонтрагентов.ВКМ_СуммаАбонентскойПлаты, 0) КАК ВКМ_СуммаАбонентскойПлаты,
	|	ДоговорыКонтрагентов.Организация КАК Организация
	|ПОМЕСТИТЬ ВТ_ДоговораДействующие
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|ГДЕ
	|	НЕ ДоговорыКонтрагентов.ПометкаУдаления
	|	И ДоговорыКонтрагентов.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание)
	|	И ДоговорыКонтрагентов.ВКМ_ДатаДействияС <= &КонецПериода
	|	И ДоговорыКонтрагентов.ВКМ_ДатаДействияПо >= &НачалоПериода
	|	И ДоговорыКонтрагентов.ВКМ_СуммаАбонентскойПлаты <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализацияТоваровУслуг.Ссылка КАК Ссылка,
	|	РеализацияТоваровУслуг.Договор КАК Договор
	|ПОМЕСТИТЬ ВТ_Реализации
	|ИЗ
	|	ВТ_ДоговораДействующие КАК ВТ_ДоговораДействующие,
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|ГДЕ
	|	НЕ РеализацияТоваровУслуг.ПометкаУдаления
	|	И РеализацияТоваровУслуг.Договор В
	|			(ВЫБРАТЬ
	|				ВТ_ДоговораДействующие.Ссылка КАК Ссылка
	|			ИЗ
	|				ВТ_ДоговораДействующие КАК Договор)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ДоговораДействующие.Ссылка КАК СсылкаДОГ,
	|	ВТ_ДоговораДействующие.Владелец КАК ВладелецДОГ,
	|	ЕСТЬNULL(ВТ_ДоговораДействующие.ВКМ_СуммаАбонентскойПлаты, 0) КАК ВКМ_СуммаАбонентскойПлатыДОГ,
	|	ВТ_ДоговораДействующие.Организация КАК ОрганизацияДОГ,
	|	ВТ_Реализации.Ссылка КАК СсылкаРТ
	|ИЗ
	|	ВТ_ДоговораДействующие КАК ВТ_ДоговораДействующие
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реализации КАК ВТ_Реализации
	|		ПО ВТ_ДоговораДействующие.Ссылка = ВТ_Реализации.Договор";
	
	Период = Объект.Период;
	КонецПериода = КонецМесяца(Период);
	НачалоПериода = НачалоМесяца(Период);
	Запрос.УстановитьПараметр("КонецПериода", КонецПериода);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Объект.Результаты.Очистить();
	
	Пока Выборка.Следующий() Цикл
		Договор = Выборка.СсылкаДОГ;
		Владелец = Выборка.ВладелецДОГ;
		Организация = Выборка.ОрганизацияДОГ;
		СтрокаТЧ = Объект.Результаты.Добавить();
		СтрокаТЧ.Договор = Договор;
		
		ШапкаСтруктура = Новый Структура;
		ШапкаСтруктура.Вставить("Контрагент",Владелец);
		ШапкаСтруктура.Вставить("Организация",Организация);
		ШапкаСтруктура.Вставить("Договор",Договор);
		ШапкаСтруктура.Вставить("СсылкаРТ",Выборка.СсылкаРТ);
		ШапкаСтруктура.Вставить("Период",Период);
		РеализацияТоваров = СоздатьДокуметРТПоДоговору(ШапкаСтруктура);
		
		Если РеализацияТоваров <> Неопределено Тогда
			СтрокаТЧ.Документ = РеализацияТоваров;
		Иначе
			Продолжить
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// ...при создании Реализации необходимо вызывать стандартный алгоритм заполнения
Функция СоздатьДокуметРТПоДоговору(ШапкаСтруктура);
	
	//ШапкаСтруктура("Контрагент",Контрагент);
	//ШапкаСтруктура("Организация",Организация);
	//ШапкаСтруктура("Договор",Договор);
	//ШапкаСтруктура("СсылкаРТ",Выборка.СсылкаРТ);
	//ШапкаСтруктура("Период",Период);
	
	СсылкаРТ = ШапкаСтруктура.СсылкаРТ;
	// ...если Реализация за выбранный месяц уже создана, то обработка не должна создавать вторую
	Создать = Ложь;
	Если НЕ ЗначениеЗаполнено(СсылкаРТ) ИЛИ СсылкаРТ = Null Тогда
		Создать = Истина;
	КонецЕсли;
	
	Если Создать Тогда
		Документ = Документы.РеализацияТоваровУслуг.СоздатьДокумент();
		
		
		ЗаполнитьЗначенияСвойств(Документ,ШапкаСтруктура); 
		Документ.Дата = ТекущаяДата(); 
		Документ.Комментарий = СтрШаблон("Создан по договору %1 за %2.",ШапкаСтруктура.Договор, Формат(ШапкаСтруктура.Период,"ДФ='MMMM yyyy ''г.'''"));
		Документ.Записать();
	Иначе
		Документ = СсылкаРТ.ПолучитьОбъект();
	КонецЕсли;
	
	// ...для заполнения Реализации необходимо использовать метод модуля объекта Реализации ВыполнитьАвтозаполнение,
	Документ.ВКМ_ВыполнитьАвтозаполнение(Документ);
	
	Документ.Записать();
	
	Если Документ.ПроверитьЗаполнение() Тогда
		Документ.Записать(РежимЗаписиДокумента.Проведение);
	Иначе
		СообщениеПоДок = Новый СообщениеПользователю;
		СообщениеПоДок.УстановитьДанные(Документ);
		СообщениеПоДок.Текст = СтрШаблон("Документ %1, НЕ проведен! т.к. не прошел проверку заполнения.",Документ);
		СообщениеПоДок.Сообщить();
	КонецЕсли;
	Возврат Документ.Ссылка;
	
КонецФункции

&НаКлиенте
Процедура СоздатьДокументы(Команда)
	Объект.Результаты.Очистить();
	
	ИДЗадания = "";
	Индикатор = 0;
	СтрокаСостояния = "";
	
	ПараметрыЗапуска = Новый Структура;
	ПараметрыЗапуска.Вставить("УИД", УникальныйИдентификатор);
	ПараметрыЗапуска.Вставить("Период", Объект.Период); 
	ПараметрыЗапуска.Вставить("ТЗнчРезультатыАдресВХ", АдресВХ); 
	
	СтруктураФоновогоЗадания = ВыполнитьФоновоеЗаданиеНаСервере(ПараметрыЗапуска);
	ИДЗадания = СтруктураФоновогоЗадания.ИдентификаторЗадания;
	
	ПараметрыОжидания  = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ПараметрыОжидания.ВыводитьПрогрессВыполнения = Истина;
	ПараметрыОжидания.Интервал  = 0;
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(СтруктураФоновогоЗадания, Новый ОписаниеОповещения("ОбработатьДанные", ЭтотОбъект), ПараметрыОжидания);
	Объект.Результаты.Очистить();
КонецПроцедуры

&НаКлиенте
Функция ОбработатьДанные(Результат, ДополнительныеПараметры) Экспорт
	
	ОтключитьОбработчикОжидания("ОбработчикОжиданияИндикатор");
	
	Если Результат = Неопределено Тогда
		Результат.Статус = "хм...";
	ИначеЕсли Результат.Статус = "Ошибка" Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(Результат.ПодробноеПредставлениеОшибки);
		ЭтаФорма.СтрокаСостояния = "Ошибка";
	ИначеЕсли Результат.Статус = "Выполнено" Тогда
		ЭтаФорма.Индикатор = 100;
		ЭтаФорма.СтрокаСостояния = "Выполнено";
	КонецЕсли;
	ОбновитьТЧРезультаты();   
	
КонецФункции    

&НаСервере
Функция ВыполнитьФоновоеЗаданиеНаСервере(ПараметрыЗапуска)
	
	НаименованиеЗадания = "Формирование РТ за месяц";
	
	ВыполняемыйМетод = "ВКМ_ФормированиеРТНаМесяц.ФормированиеДокументов";
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияВФоне(УникальныйИдентификатор);
	ПараметрыВыполнения.НаименованиеФоновогоЗадания = НаименованиеЗадания;
	ПараметрыВыполнения.ЗапуститьВФоне = Истина;
	ПараметрыВыполнения.Вставить("ИдентификаторФормы", УникальныйИдентификатор); 
	
	СтруктураФоновогоЗадания = ДлительныеОперации.ВыполнитьВФоне(ВыполняемыйМетод, ПараметрыЗапуска, ПараметрыВыполнения);
	
	Возврат СтруктураФоновогоЗадания;
	
КонецФункции

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	АдресВХ = ПоместитьВоВременноеХранилище(Неопределено,УникальныйИдентификатор);
	
КонецПроцедуры

&НаСервере
Функция ОбновитьТЧРезультатыНаСервере() 
	
	ТЗнчРезультат = ПолучитьИзВременногоХранилища(АдресВХ);
	Объект.Результаты.Загрузить(ТЗнчРезультат);
	ТЧРезультаты.Загрузить(ТЗнчРезультат); 
	
КонецФункции

&НаКлиенте
Процедура ОбновитьТЧРезультаты() 
	
	ОбновитьТЧРезультатыНаСервере();   
	
КонецПроцедуры     